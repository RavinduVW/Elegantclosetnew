rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    function isAdmin() {
      return request.auth != null && 
             firestore.exists(/databases/(default)/documents/admin_users/$(request.auth.uid)) &&
             firestore.get(/databases/(default)/documents/admin_users/$(request.auth.uid)).data.active == true;
    }
    
    function isValidImageSize(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }
    
    function isValidImageType() {
      return request.resource.contentType.matches('image/(jpeg|jpg|png|gif|webp|svg\\+xml|bmp|avif|heic|heif)');
    }
    
    function hasValidFilename() {
      return request.resource.name.size() > 0 && 
             request.resource.name.size() < 256;
    }
    
    function isValidUpload(maxSizeMB) {
      return isAdmin() && 
             isValidImageSize(maxSizeMB) && 
             isValidImageType() && 
             hasValidFilename();
    }
    
    match /products/{allPaths=**} {
      allow read: if true;
      allow write, delete: if isValidUpload(50);
    }
    
    match /media/{allPaths=**} {
      allow read: if true;
      allow write, delete: if isValidUpload(50);
    }
    
    match /content/{allPaths=**} {
      allow read: if true;
      allow write, delete: if isValidUpload(50);
    }
    
    match /categories/{allPaths=**} {
      allow read: if true;
      allow write, delete: if isValidUpload(10);
    }
    
    match /site/{allPaths=**} {
      allow read: if true;
      allow write, delete: if isValidUpload(10);
    }
    
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
