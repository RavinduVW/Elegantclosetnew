rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is an admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.active == true;
    }
    
    // Helper function to check admin role
    function hasRole(role) {
      return isAdmin() && 
             get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.role == role;
    }
    
    // Helper function to check permission level
    function hasPermission(resource, level) {
      let userData = get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data;
      return userData.role == 'super_admin' || 
             (userData.permissions[resource] == level || userData.permissions[resource] == 'admin');
    }
    
    // Products collection
    match /products/{productId} {
      allow read: if true; // Public can read published products
      allow create: if isAdmin() && hasPermission('products', 'write');
      allow update: if isAdmin() && hasPermission('products', 'write');
      allow delete: if isAdmin() && hasPermission('products', 'admin');
    }
    
    // Categories collection
    match /categories/{categoryId} {
      allow read: if true; // Public can read active categories
      allow create: if isAdmin() && hasPermission('categories', 'write');
      allow update: if isAdmin() && hasPermission('categories', 'write');
      allow delete: if isAdmin() && hasPermission('categories', 'admin');
    }
    
    // Content blocks collection
    match /content_blocks/{blockId} {
      allow read: if true; // Public can read visible content
      allow create: if isAdmin() && hasPermission('content', 'write');
      allow update: if isAdmin() && hasPermission('content', 'write');
      allow delete: if isAdmin() && hasPermission('content', 'admin');
    }
    
    // Site settings collection
    match /site_settings/{settingId} {
      allow read: if true; // Public can read site settings
      allow write: if isAdmin() && hasPermission('settings', 'write');
    }
    
    // Navigation menus collection
    match /navigation_menus/{menuId} {
      allow read: if true; // Public can read navigation menus
      allow write: if isAdmin() && hasPermission('settings', 'write');
    }
    
    // FAQs collection
    match /faqs/{faqId} {
      allow read: if true;
      allow create: if isAdmin() && hasPermission('content', 'write');
      allow update: if isAdmin() && hasPermission('content', 'write');
      allow delete: if isAdmin() && hasPermission('content', 'admin');
    }
    
    // About page content collection
    match /about/{contentId} {
      allow read: if true;
      allow create: if isAdmin() && hasPermission('content', 'write');
      allow update: if isAdmin() && hasPermission('content', 'write');
      allow delete: if isAdmin() && hasPermission('content', 'admin');
    }
    
    // Sizes collection
    match /sizes/{sizeId} {
      allow read: if true;
      allow create: if isAdmin() && hasPermission('products', 'write');
      allow update: if isAdmin() && hasPermission('products', 'write');
      allow delete: if isAdmin() && hasPermission('products', 'admin');
    }
    
    // Colors collection
    match /colors/{colorId} {
      allow read: if true;
      allow create: if isAdmin() && hasPermission('products', 'write');
      allow update: if isAdmin() && hasPermission('products', 'write');
      allow delete: if isAdmin() && hasPermission('products', 'admin');
    }
    
    // Media collection
    match /media/{mediaId} {
      allow read: if true; // Public can read media metadata
      allow create: if isAdmin() && hasPermission('media', 'write');
      allow update: if isAdmin() && hasPermission('media', 'write');
      allow delete: if isAdmin() && hasPermission('media', 'admin');
    }
    
    // Orders collection
    match /orders/{orderId} {
      allow read: if isAdmin() && hasPermission('orders', 'read');
      allow create: if true; // Customers can create orders
      allow update: if isAdmin() && hasPermission('orders', 'write');
      allow delete: if false; // Orders should not be deleted
    }
    
    // Admin users collection
    match /admin_users/{userId} {
      allow read: if isAdmin(); // All admins can read admin users
      allow write: if hasRole('super_admin'); // Only super admins can modify
    }
    
    // Admin logs collection
    match /admin_logs/{logId} {
      allow read: if isAdmin() && hasPermission('settings', 'read');
      allow create: if isAdmin(); // Any admin can create logs
      allow update, delete: if false; // Logs are immutable
    }
  }
}