rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is an admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.active == true;
    }
    
    // Helper function to check admin role
    function hasRole(role) {
      return isAdmin() && 
             get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.role == role;
    }
    
    // Helper function to check permission level
    function hasPermission(resource, level) {
      let userData = get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data;
      return userData.role == 'super_admin' || 
             (userData.permissions[resource] == level || userData.permissions[resource] == 'admin');
    }
    
    // DEVELOPMENT: Allow any authenticated user (bypass admin checks)
    // TODO: Change to isAdmin() && hasPermission() in production
    function canWrite() {
      return request.auth != null;
    }
    
    // Products collection
    match /products/{productId} {
      allow read: if true;
      allow create: if canWrite() && validateProduct();
      allow update: if canWrite() && validateProduct();
      allow delete: if canWrite();
    }
    
    function validateProduct() {
      let data = request.resource.data;
      return data.name is string && data.name.size() > 0 &&
             data.sku is string && data.sku.size() > 0 &&
             data.price is number && data.price > 0 &&
             data.slug is string && data.slug.size() > 0 &&
             data.currency is string &&
             data.status in ['draft', 'published', 'archived'] &&
             data.visibility in ['public', 'private', 'password'] &&
             data.colors is list &&
             data.sizes is list &&
             data.tags is list &&
             data.images is list && data.images.size() > 0 &&
             data.featuredImage is string &&
             (!('categoryId' in data) || data.categoryId is string) &&
             (!('subCategoryId' in data) || data.subCategoryId is string) &&
             (!('salePrice' in data) || (data.salePrice is number && data.salePrice < data.price));
    }
    
    // Categories collection
    match /categories/{categoryId} {
      allow read: if true; // Public can read active categories
      allow create: if canWrite();
      allow update: if canWrite();
      allow delete: if canWrite();
    }
    
    // Content blocks collection
    match /content_blocks/{blockId} {
      allow read: if true; // Public can read visible content
      allow create: if canWrite();
      allow update: if canWrite();
      allow delete: if canWrite();
    }
    
    // Site settings collection
    match /site_settings/{settingId} {
      allow read: if true; // Public can read site settings
      allow write: if canWrite();
    }
    
    // Navigation menus collection
    match /navigation_menus/{menuId} {
      allow read: if true; // Public can read navigation menus
      allow write: if canWrite();
    }
    
    // FAQs collection
    match /faqs/{faqId} {
      allow read: if true;
      allow create: if canWrite();
      allow update: if canWrite();
      allow delete: if canWrite();
    }
    
    // About page content collection
    match /about/{contentId} {
      allow read: if true;
      allow create: if canWrite();
      allow update: if canWrite();
      allow delete: if canWrite();
    }
    
    // Sizes collection
    match /sizes/{sizeId} {
      allow read: if true;
      allow create: if canWrite();
      allow update: if canWrite();
      allow delete: if canWrite();
    }
    
    // Colors collection
    match /colors/{colorId} {
      allow read: if true;
      allow create: if canWrite();
      allow update: if canWrite();
      allow delete: if canWrite();
    }
    
    // Media collection
    match /media/{mediaId} {
      allow read: if true; // Public can read media metadata
      allow create: if canWrite();
      allow update: if canWrite();
      allow delete: if canWrite();
    }
    
    // Orders collection
    match /orders/{orderId} {
      allow read: if isAdmin() && hasPermission('orders', 'read');
      allow create: if true; // Customers can create orders
      allow update: if isAdmin() && hasPermission('orders', 'write');
      allow delete: if false; // Orders should not be deleted
    }
    
    // Admin users collection
    match /admin_users/{userId} {
      allow read: if isAdmin(); // All admins can read admin users
      allow write: if hasRole('super_admin'); // Only super admins can modify
    }
    
    // Admin logs collection
    match /admin_logs/{logId} {
      allow read: if isAdmin() && hasPermission('settings', 'read');
      allow create: if isAdmin();
      allow update, delete: if false;
    }
    
    // Contact settings collection
    match /contact_settings/{settingId} {
      allow read: if true;
      allow write: if canWrite();
    }
    
    // Contact messages collection
    match /contact_messages/{messageId} {
      allow read: if canWrite();
      allow create: if true;
      allow update: if canWrite();
      allow delete: if canWrite();
    }
    
    // Hero settings collection
    match /hero_settings/{settingId} {
      allow read: if true; // Public can read hero settings for homepage
      allow write: if canWrite();
    }
  }
}